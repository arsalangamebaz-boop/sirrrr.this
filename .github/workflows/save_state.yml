name: Save Instagram Storage State

on:
  workflow_dispatch:

jobs:
  save-state:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Playwright
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install
          npx playwright install-deps

      - name: Generate storage_state.json
        env:
          IG_USER: ${{ secrets.IG_USER }}
          IG_PASS: ${{ secrets.IG_PASS }}
        run: |
          python - <<'EOF'
          from playwright.sync_api import sync_playwright
          import json, os, sys

          username = os.getenv("IG_USER")
          password = os.getenv("IG_PASS")

          if not username or not password:
              sys.exit("❌ IG_USER / IG_PASS secrets missing.")

          with sync_playwright() as p:
              browser = p.chromium.launch(
                  headless=True,
                  args=["--disable-blink-features=AutomationControlled", "--no-sandbox", "--disable-dev-shm-usage"]
              )
              context = browser.new_context()
              page = context.new_page()
              page.goto("https://www.instagram.com/accounts/login/", timeout=90000)
              page.wait_for_timeout(5000)  # let assets load

              # Try multiple possible login input selectors
              selectors = [
                  "input[name='username']",
                  "input[name='email']",
                  "input[aria-label='Phone number, username, or email']",
                  "input[type='text']"
              ]

              found = None
              for sel in selectors:
                  try:
                      page.wait_for_selector(sel, timeout=20000)
                      found = sel
                      break
                  except Exception:
                      continue

              if not found:
                  print("❌ Could not find username input field.")
                  print("🔎 Page preview:\n", page.content()[:300])  # DEBUG: print first 300 chars of HTML
                  sys.exit(1)

              page.fill(found, username)

              # password field
              pw_selectors = ["input[name='password']", "input[type='password']"]
              pw_found = None
              for sel in pw_selectors:
                  try:
                      page.wait_for_selector(sel, timeout=20000)
                      pw_found = sel
                      break
                  except Exception:
                      continue

              if not pw_found:
                  print("❌ Could not find password input field.")
                  print("🔎 Page preview:\n", page.content()[:300])  # DEBUG
                  sys.exit(1)

              page.fill(pw_found, password)

              # click login button
              try:
                  page.click("button[type='submit']")
              except:
                  page.keyboard.press("Enter")

              try:
                  page.wait_for_selector("nav", timeout=90000)
              except:
                  print("❌ Login failed or blocked.")
                  print("🔎 Page preview:\n", page.content()[:300])  # DEBUG
                  sys.exit(1)

              state = context.storage_state()
              print("✅ Copy the JSON below into IG_STORAGE_STATE_JSON secret:\n")
              print(json.dumps(state))
              browser.close()
          EOF
