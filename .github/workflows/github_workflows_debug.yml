name: Debug Instagram Automation

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  debug-bot:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright
      run: |
        playwright install chromium
        playwright install-deps chromium

    - name: Debug Environment
      run: |
        echo "ğŸ” Checking drive_links.txt:"
        cat drive_links.txt || echo "âŒ drive_links.txt not found"
        echo "ğŸ“¦ Python packages:"
        pip list
        echo "ğŸŒ Environment variables (safe):"
        env | grep -v -i "secret\|token\|key\|pass\|auth"

    - name: Write storage_state.json
      run: |
        if [ -n "$IG_STORAGE_STATE_JSON" ]; then
          echo "$IG_STORAGE_STATE_JSON" > storage_state.json
          echo "âœ… storage_state.json written"
          echo "ğŸ“ File size: $(wc -c < storage_state.json) bytes"
        else
          echo "âŒ IG_STORAGE_STATE_JSON not set"
          exit 1
        fi
      env:
        IG_STORAGE_STATE_JSON: ${{ secrets.IG_STORAGE_STATE_JSON }}
        
    - name: Upload debug screenshots
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: debug-screenshots
        path: |
          debug_*.png
          storage_state.json
          
    - name: Run bot with debug (headful)
      env:
        IG_STORAGE_STATE_PATH: storage_state.json
        PLAYWRIGHT_HEADLESS: false   # <-- run headful for debugging
        CI: true
        GITHUB_ACTIONS: true
        DEBUG: true
      run: |
        echo "ğŸš€ Starting bot execution..."
        python -u main.py  # -u for unbuffered output
        echo "âœ… Bot execution completed"

    - name: Keep debug artifacts
      if: always()
      run: |
        echo "ğŸ” Leaving storage_state.json (for post-run inspection)"
        ls -la
        echo "âœ… Debug run complete. Please review debug_*.png and console logs."
